<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yjc.find.dao.MessageMapper">
    <select id="selectSysMessagePage" parameterType="java.util.Map" resultType="com.yjc.find.pojo.Message">
        select tm.*
        from tb_message tm
        left join tb_user receive on tm.receive_id = receive.id
        left join tb_message_read tmr on tmr.receive_id = tm.receive_id and tmr.message_id = tm.id
        where
        send_id = 0 and (tm.receive_id = 0 or tm.receive_id =#{receiveId})
        <if test="isRead!=null and isRead!=''and isRead==0">
            and tm.id not in (select tmr.message_id from tmr where tmr.receive_id =#{receiveId} and tmr.read_status =1)
        </if>
        and tmr.delete_tag = 0
        order by  tm.create_date desc
        limit #{beginIndex},#{limit}
    </select>
    <select id="selectSysMessageCount" parameterType="java.util.Map" resultType="Integer">
        select count(*)
        from tb_message tm
        left join tb_user receive on tm.receive_id = receive.id
        left join tb_message_read tmr on tmr.receive_id = tm.receive_id and tmr.message_id = tm.id
        where
        send_id = 0 and (tm.receive_id = 0 or tm.receive_id =#{receiveId})
        <if test="isRead!=null and isRead!=''and isRead==0">
            and tm.id not in (select tmr.message_id from tmr where tmr.receive_id =#{receiveId} and tmr.read_status =1)
        </if>
        and tmr.delete_tag = 0
        and
    </select>
    <select id="selectPriMessagePage" parameterType="java.util.Map" resultType="com.yjc.find.pojo.Message">
        select tm.*,send.nick_name as sendName,send.user_img_addr as send_img_addr
        from tb_message tm
        left join tb_user send on tm.send_id = send.id
        left join tb_user receive on tm.receive_id = receive.id
        where tm.send_id > 0
        and tm.receive_id = #{receiveId}
        <if test="isRead!=null and isRead!=''">
            and tm.is_read = #{isRead}
        </if>
        ORDER BY tm.create_date desc
        limit #{beginIndex},#{limit}
    </select>

    <select id="selectMessage" parameterType="Long" resultType="com.yjc.find.pojo.Message">
        select tm.*,send.nick_name as sendName,send.user_img_addr as send_img_addr
        from tb_message tm
        left join tb_user send on tm.send_id = send.id
        where tm.id = #{id}
    </select>
    <delete id="deletePri" parameterType="Long" >
        delete from tb_message where receive_id=#{id} and send_id >0 and is_read = 1
    </delete>
    <update id="updateMessageList" parameterType="java.util.List">
        <foreach collection="messageIdList" item="item" index="index" open="" close="" separator=";">
            update tb_message
            <set>
                is_read = 1
            </set>
            where id = ${item} and send_id>0
        </foreach>
    </update>
    <select id="selectSysIds" resultType="Long">
        select id from tb_message where send_id = 0 and (receive_id)
    </select>



    <select id="selectMessageOne" parameterType="Long" resultType="com.yjc.find.pojo.Message">
        select tm.*,send.nick_name as sendName,send.user_img_addr as send_img_addr
        from tb_message tm
        left join tb_user send on tm.send_id = send.id
        where tm.id = #{id}
    </select>
    <select id="selectMessagePage" parameterType="java.util.Map" resultType="com.yjc.find.pojo.Message">
        select tm.*,send.nick_name as sendName,send.user_img_addr as send_img_addr
        from tb_message tm
        left join tb_user send on tm.send_id = send.id
        left join tb_user receive on tm.receive_id = receive.id
        where tm.send_id > 0
        and tm.receive_id = #{receiveId}
        <if test="isRead!=null and isRead!=''">
            and tm.is_read = #{isRead}
        </if>
        ORDER BY tm.create_date desc
        limit #{beginIndex},#{limit}
    </select>
    <select id="selectMessageCount" parameterType="java.util.Map" resultType="Integer">
        select count(*)
        from tb_message tm
        left join tb_user send on tm.send_id = send.id
        left join tb_user receive on tm.receive_id = receive.id
        where tm.send_id > 0
        and tm.receive_id = #{receiveId}
        <if test="isRead!=null and isRead!=''">
            and tm.is_read = #{isRead}
        </if>
    </select>
</mapper>
